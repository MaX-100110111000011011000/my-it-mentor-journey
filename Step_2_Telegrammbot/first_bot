import telebot
import requests
import datetime


# --- –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
def log_request(user_id, text):
    with open(".gitignore/bot_log.txt", "a", encoding="utf-8") as f:
        dt = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        f.write(f"[{dt}] User {user_id} sent: {text}\n")


# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
TOKEN = open(".gitignore/TOKEN.txt", "r").read().strip()
ADMIN_ID = int(open(".gitignore/admin.txt", "r").read().strip())
bot = telebot.TeleBot(TOKEN)


@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn1 = telebot.types.KeyboardButton("–ö—É—Ä—Å –≤–∞–ª—é—Ç")
    markup.add(btn1)
    bot.send_message(message.chat.id, "–ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)


@bot.message_handler(commands=['stats'])
def send_stats(message):
    if message.from_user.id == ADMIN_ID:
        total_requests = 0
        curs_requests = 0
        with open(".gitignore/bot_log.txt", "r", encoding="utf-8") as f:
            for line in f:
                total_requests += 1
                if "–ö—É—Ä—Å –≤–∞–ª—é—Ç" in line:
                    curs_requests += 1
        bot.send_message(message.chat.id, f"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n–í—Å–µ–≥–æ: {total_requests}\n–ö—É—Ä—Å: {curs_requests}")
    else:
        bot.send_message(message.chat.id, "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")


# --- –õ–æ–≥–∏–∫–∞ –≤–∞–ª—é—Ç ---
def get_currency_pair(message):
    """–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –í–¢–û–†–û–ô, –∫–æ–≥–¥–∞ —é–∑–µ—Ä –Ω–∞–ø–∏—à–µ—Ç –∫–æ–¥ –≤–∞–ª—é—Ç—ã"""
    log_request(message.from_user.id, message.text)  # –õ–æ–≥–∏—Ä—É–µ–º –∏ —ç—Ç–æ—Ç —à–∞–≥ —Ç–æ–∂–µ
    try:
        user_choice = message.text.upper().strip()  # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –∫–∞–ø—Å (USD, EUR)
        url = "https://open.er-api.com/v6/latest/USD"
        data = requests.get(url).json()

        if user_choice in data["rates"]:
            rub_rate = data["rates"]["RUB"]
            target_rate = data["rates"][user_choice]
            curs = round(rub_rate / target_rate, 3)
            bot.send_message(message.chat.id, f"üìä –ö—É—Ä—Å: 1 {user_choice} = {curs} RUB")
        else:
            bot.send_message(message.chat.id, "–Ø –Ω–µ –∑–Ω–∞—é —Ç–∞–∫–æ–π –≤–∞–ª—é—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä: EUR, CNY, USD)")
    except Exception as e:
        bot.reply_to(message, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")


@bot.message_handler(func=lambda message: True)
def handle_message(message):
    log_request(message.from_user.id, message.text)

    # –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ö—É—Ä—Å –≤–∞–ª—é—Ç"
    if message.text == "–ö—É—Ä—Å –≤–∞–ª—é—Ç":
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ—Ö–±—É–∫–≤–µ–Ω–Ω—ã–π –∫–æ–¥ –≤–∞–ª—é—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: EUR, USD, CNY):")
        # –†–ï–ì–ò–°–¢–†–ò–†–£–ï–ú –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì:
        bot.register_next_step_handler(msg, get_currency_pair)
        return


print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.infinity_polling()
